# 不動産取引価格分析アプリケーション 要件定義書

## 1. 概要

本アプリケーションは、国土交通省が提供する不動産取引価格情報APIを利用して、不動産取引データを取得・分析・可視化するためのStreamlitベースのWebアプリケーションです。ユーザーは直感的なインターフェースを通じて、不動産市場の動向を把握し、データに基づいた意思決定を行うことができます。

## 2. 主要機能

### 2.1 データ取得機能
- 国土交通省APIからの不動産取引データの取得
- 年度選択（2019年〜2024年）
- 都道府県の選択
- 選択した都道府県に対応する市区町村の動的取得・選択
- APIキーによる認証
- 検索条件変更時の自動データリセット機能

### 2.2 データ分析機能
- 基本統計情報の表示（平均価格、中央値、最小値、最大値など）
- 価格分布のヒストグラム表示
- 価格帯別の割合（円グラフ）
- 物件タイプ別の価格分布（箱ひげ図）
- 築年数と価格の関係（散布図）
- 地区別の平均価格・物件数の分析
- 相関分析（ヒートマップ）
- 時系列トレンド分析
- 平米単価の分析
- 構造別の価格分析

### 2.3 四半期ごとの価格推移分析機能
- 過去の四半期データの一括取得と分析
- 物件タイプ別の四半期ごとの価格推移グラフ
- 標準偏差を含めた価格ばらつきの可視化
- 価格トレンドの自動分析と解説
- 基準年を選択して任意の期間のデータを取得
- グラフ要素の詳細説明機能

### 2.4 価格予測機能
- 機械学習モデルを用いた価格予測
  - ランダムフォレスト
  - 勾配ブースティング
  - XGBoost
  - LightGBM
  - アンサンブル学習
- 特徴量の重要度表示
- ユーザー入力による価格予測
- 予測結果の解釈と信頼区間の表示
- 自動的な最適モデル選択機能
- ハイパーパラメータチューニング

### 2.5 データフィルタリング機能
- 物件タイプによるフィルタリング
- 価格範囲によるフィルタリング
- 築年数範囲によるフィルタリング
- 外れ値処理機能
  - IQR法（四分位範囲法）
  - Z-score法（標準偏差）
  - DBSCAN法（クラスタリング）

### 2.6 データエクスポート機能
- CSVフォーマットでのデータダウンロード
- Excelフォーマットでのデータダウンロード（統計情報シート付き）
- 要約レポートの生成とMarkdown形式でのダウンロード

### 2.7 開発者オプション
- デバッグモードの切り替え（詳細なデバッグ情報の表示/非表示）
- 四半期データ取得時のエラー詳細表示オプション
- 地域特徴量の生成と重み付け調整

## 3. 技術仕様

### 3.1 開発環境
- 言語: Python 3.8以上
- ウェブフレームワーク: Streamlit
- データ処理: Pandas, NumPy
- 可視化: Matplotlib, Seaborn, Plotly
- 機械学習: scikit-learn, XGBoost, LightGBM
- 統計処理: SciPy
- その他: japanize-matplotlib, xlsxwriter, requests

### 3.2 外部API
- 国土交通省 不動産取引価格情報API
  - 不動産取引データ取得API (XIT001)
  - 都道府県内市区町村一覧取得API (XIT002)
  - 認証方式: APIキー (header: Ocp-Apim-Subscription-Key)

### 3.3 アプリケーション構成
- app.py: メインアプリケーションファイル
- data_handler.py: データ取得・処理モジュール
- visualizers.py: データ可視化モジュール
- models.py: 機械学習・予測モジュール
- price_trends.py: 四半期ごとの価格推移分析モジュール
- utils.py: ユーティリティ関数モジュール
- requirements.txt: 依存ライブラリ一覧
- README.md: プロジェクト説明

### 3.4 詳細ファイル構成

```
realestate-app/
├── app.py                    # メインのアプリケーションファイル
├── data_handler.py           # データ取得・処理モジュール
├── visualizers.py            # データ可視化モジュール
├── models.py                 # 機械学習・予測モジュール
├── price_trends.py           # 四半期ごとの価格推移分析モジュール
├── utils.py                  # ユーティリティ関数モジュール
├── requirements.txt          # 依存ライブラリ
└── README.md                 # プロジェクト説明
```

### 3.5 各ファイルの役割

**app.py**
- メインのアプリケーションエントリーポイント
- Streamlitインターフェースの定義
- サイドバー、タブ、メインコンテンツの構成
- ユーザー入力の処理とデータフローの制御
- 検索条件変更時のデータリセット機能

**data_handler.py**
- 国土交通省APIとの通信処理
- データの取得関数 (`get_real_estate_data`, `get_municipalities`)
- データの前処理関数 (`preprocess_data`)
- 外れ値検出・処理関数 (`remove_outliers`)
- 地域特徴量の追加関数 (`add_district_features`)
- キャッシュ機能を持つラッパー関数 (`fetch_and_process_data`)

**visualizers.py**
- データの可視化関数群
- 基本統計表示 (`show_basic_stats`)
- 価格分析関連グラフ (`plot_price_histogram`, `plot_price_pie_chart`, `plot_price_by_type`)
- エリア分析関連グラフ (`plot_district_prices`)
- 高度な分析関連グラフ (`plot_heatmap`, `plot_time_trend`, `plot_price_per_sqm`)

**models.py**
- 機械学習モデル関連処理
- 価格予測モデルの構築 (`train_price_prediction_model`)
- 特徴量重要度の表示 (`show_feature_importance`)
- ユーザー入力による予測 (`predict_with_model`)
- 予測結果の解釈と表示 (`show_prediction_form_and_results`, `show_prediction_interpretation`)
- 複数モデルのアンサンブル学習機能
- ハイパーパラメータチューニング処理

**price_trends.py**
- 四半期ごとの価格推移分析機能
- 過去の四半期データ取得 (`fetch_historical_price_data`)
- 四半期データの集計・加工 (`prepare_quarterly_price_data`)
- 四半期ごとの価格推移グラフ作成 (`plot_quarterly_price_trends`)
- 価格トレンド分析と解説 (`show_trend_analysis`)
- グラフ要素の説明機能
- 基準年選択機能

**utils.py**
- 都道府県コードと名称の辞書 (`get_prefecture_dict`)
- 市区町村リスト取得 (`get_city_options`)
- 価格表示フォーマット (`format_price`)
- データフィルタリング (`filter_dataframe`)
- 要約レポート生成 (`generate_summary_report`)

## 4. 画面構成

### 4.1 サイドバー
- 検索条件設定（年度、都道府県、市区町村）
- APIキー入力フィールド
- データ取得ボタン
- データフィルタリングオプション
- データ処理設定（外れ値処理、地域特徴量）
- 四半期推移の設定（四半期推移タブ選択時のみ表示）
- 開発者オプション（デバッグモード切替）
- ヘルプと使い方ガイド

### 4.2 メインコンテンツ
- タブ形式のインターフェース
  - 基本統計タブ: 統計情報とデータテーブル
  - 価格分析タブ: 価格分布、物件タイプ別分析など
  - エリア分析タブ: 地区別の価格と物件数
  - 高度な分析タブ: 相関分析、時系列分析など
  - 価格予測タブ: 機械学習モデルと予測機能
  - 四半期推移タブ: 四半期ごとの価格推移分析
- データダウンロードセクション
- 要約レポート生成・表示セクション

### 4.3 価格予測タブの詳細構成
- 特徴量選択
  - 使用する特徴量の選択（面積、築年数、物件タイプなど）
- モデル選択
  - モデルタイプ選択（自動選択、ランダムフォレスト、勾配ブースティングなど）
  - 高度なモデル設定オプション
    - 交差検証の分割数
    - テストデータの割合
    - ハイパーパラメータチューニング設定
- モデル評価指標の表示
  - 決定係数（R²）
  - RMSE（平均二乗誤差の平方根）
  - MAE（平均絶対誤差）
  - モデル品質の評価
- 予測フォーム
  - 特徴量の入力フィールド（数値特徴量、カテゴリカル特徴量）
  - 高度な予測設定（信頼区間の幅など）
- 予測結果表示
  - 予測価格の表示
  - 信頼区間の計算と表示
  - 予測価格の視覚化（ゲージなど）
  - 市場内での位置づけの解説
  - 物件タイプ別の比較

### 4.4 四半期推移タブの詳細構成
- 四半期データ取得設定
  - 取得する四半期数の選択（4〜12）
  - 基準年の選択（2019年〜2024年）
  - 表示する物件タイプの選択
- データ取得プログレスバー
- 成功・失敗した四半期データの表示
- 四半期ごとの価格推移グラフ
  - 物件タイプ別の折れ線グラフ
  - 標準偏差を表す塗りつぶし領域
  - グラフの見方を説明する折りたたみセクション
- 価格トレンド分析レポート
  - 物件タイプごとの価格変動分析
  - 直近のトレンド変化の検出

## 5. データ処理フロー

### 5.1 基本データ処理フロー
1. ユーザーが検索条件とAPIキーを入力
2. 都道府県選択時に、対応する市区町村リストをAPIから取得
3. データ取得ボタンクリック時に不動産取引APIを呼び出し
4. 取得したデータを前処理（数値変換、築年数計算、価格帯分類など）
5. 外れ値処理（IQR法、Z-score法、DBSCAN法）
6. 地域特徴量の追加（地区別の平均価格、物件数、クラスタリングなど）
7. フィルタリング条件に基づきデータを絞り込み
8. 各タブでデータの分析・可視化を実行
9. 必要に応じてデータのダウンロードや要約レポートを生成

### 5.2 価格予測フロー
1. ユーザーが使用する特徴量とモデルタイプを選択
2. モデル構築ボタンクリック時に学習処理を実行
   - トレーニングデータとテストデータの分割
   - モデルタイプに応じたアルゴリズム選択
   - 自動選択の場合は複数モデルを評価
   - ハイパーパラメータチューニング（設定されている場合）
3. モデル評価指標（R²、RMSE、MAE）の表示
4. 特徴量の重要度を表示
5. 予測フォームを表示
6. ユーザーが特徴量の値を入力し、予測実行ボタンをクリック
7. 入力値を前処理（One-Hot Encoding、スケーリングなど）
8. モデルによる価格予測の実行
9. 予測結果と信頼区間の表示
10. 予測結果の解釈表示（市場内での位置づけなど）

### 5.3 四半期推移データ処理フロー
1. ユーザーが基準年、取得する四半期数を選択
2. 「四半期ごとの価格推移を取得」ボタンをクリック
3. 指定した基準年（デフォルトでは現在選択中の年）の第4四半期から遡って各四半期のデータを取得
4. 取得した四半期データごとに処理（年・四半期情報を追加）
5. 物件タイプと四半期ごとにデータを集計（平均価格、標準偏差、取引件数）
6. 四半期ごとの価格推移グラフを生成
7. 価格トレンドを自動分析し、傾向を表示

## 6. 非機能要件

### 6.1 パフォーマンス
- 500件以上のデータセットでもスムーズに動作
- API呼び出し結果のキャッシュ対応（@st.cache_data）
- 複数回のAPI呼び出しを最適化（四半期データ取得など）
- 大規模データセットでのメモリ使用量最適化（データ型の適正化）

### 6.2 セキュリティ
- APIキーの安全な取り扱い（パスワードフィールドでの表示、セッションのみでの保持）

### 6.3 エラーハンドリング
- API接続エラーの適切な処理と表示
- データ処理中のエラーハンドリングと詳細なデバッグ情報の提供
- 存在しない四半期データへのアクセスの適切な処理
- 予測時の特徴量不整合エラーの処理

### 6.4 ユーザビリティ
- 直感的なUI/UX設計
- レスポンシブなデザイン
- ヘルプと使い方ガイドの提供
- データ取得進捗の視覚化（プログレスバー）
- グラフの解釈をサポートする説明機能
- 予測結果の詳細な解釈提供
- モデル評価指標の分かりやすい説明

### 6.5 保守性・拡張性
- モジュール化された設計によるメンテナンス性の向上
- 機能ごとにファイルを分割し、拡張性を確保
- 将来の機能追加を考慮したコード構造
- デバッグモードによる問題診断の容易化

## 7. 実装済み機能と今後の拡張可能性

### 7.1 実装済み機能
- 基本的なデータ取得・可視化機能
- データフィルタリング機能
- 外れ値処理機能（複数手法）
- 地域特徴量の自動生成機能
- 高度な分析機能（相関分析、時系列分析）
- 機械学習による価格予測（複数アルゴリズム対応）
- 四半期ごとの価格推移分析
- 検索条件変更時の自動データリセット
- グラフの詳細な説明機能
- 予測結果の詳細な解釈と視覚化

### 7.2 今後の拡張可能性
- 地図ベースの視覚化（位置情報の活用）
- 複数地域の比較分析機能
- より高度な機械学習モデルの導入（深層学習など）
- データのバッチ処理機能
- 過去のデータ分析結果の保存・履歴機能
- ユーザー認証とパーソナライズされた分析設定の保存
- 予測履歴の保存と比較機能
- 複数データソースの統合（民間不動産データなど）
- 予測結果のPDF出力機能

## 8. 制限事項と前提条件

- 国土交通省APIキーが必要
- APIの利用制限・規約に準拠する必要あり
- データ取得時の年度範囲は2019年〜2024年（APIの提供範囲に依存）
- 一部の四半期データが存在しない可能性あり
- 取得できる市区町村リストはAPIに依存
- 予測精度はデータ量と品質に依存
- 特定の地域や物件タイプではデータ不足により予測が困難な場合あり

## 9. デプロイ手順

### 9.1 ローカル環境での実行
1. リポジトリをクローン
   ```
   git clone https://github.com/username/realestate-analysis-app.git
   cd realestate-analysis-app
   ```

2. 仮想環境の作成と有効化
   ```
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   ```

3. 依存パッケージのインストール
   ```
   pip install -r requirements.txt
   ```

4. アプリケーションの実行
   ```
   streamlit run app.py
   ```

### 9.2 Streamlit Cloudへのデプロイ
1. GitHubリポジトリにプロジェクトをプッシュ
2. Streamlit Cloudにログイン
3. 「New app」ボタンからデプロイ設定
   - リポジトリURL: github.com/username/realestate-analysis-app
   - ブランチ: main
   - メインファイル: app.py
4. 「Deploy」ボタンでデプロイ実行
5. シークレットの設定（必要に応じて）

### 9.3 デプロイ時の注意点
- APIキーはStreamlit Cloudのシークレット機能で管理することを推奨
- requirements.txtに必要なパッケージをすべて記載
- Pythonバージョンは3.8以上を指定
- TensorFlowなど一部のライブラリはプラットフォームによってインストール方法が異なる場合があるため注意

本要件定義書は、現在のアプリケーション機能を反映したものです。今後のユーザーフィードバックや追加要件に応じて更新される可能性があります。